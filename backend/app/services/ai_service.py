from typing import Optional
import base64
import httpx

from app.config import get_settings
from app.models.chat import Diagnosis

settings = get_settings()


# –ü—Ä–æ–º–ø—Ç –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ–±—â–µ–Ω–∏—è
TEXT_SYSTEM_PROMPT = """–¢—ã ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫-—Ñ–µ—Ä–º–µ—Ä. –û–±—ä—è—Å–Ω—è–π –∫–∞–∫ –¥–ª—è –ø–æ–¥—Ä–æ—Å—Ç–∫–∞ 12-14 –ª–µ—Ç: –ø–æ–Ω—è—Ç–Ω–æ, –Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º –ø—Ä–æ—Å—Ç–æ.

–í–ê–ñ–ù–û ‚Äî –ß–ï–°–¢–ù–û–°–¢–¨ –ò –¢–û–ß–ù–û–°–¢–¨:
- –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω ‚Äî —Å–∫–∞–∂–∏ "–ò–∑–≤–∏–Ω–∏, –Ω–µ –Ω–∞—à—ë–ª —Ç–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É" –∏–ª–∏ "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —É –º–µ–Ω—è –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ–± —ç—Ç–æ–º"
- –ù–ï –≤—ã–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π
- –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚Äî —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏: "–ù–µ —Å–º–æ–≥ –Ω–∞–π—Ç–∏ –Ω–∞–¥—ë–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –ª—É—á—à–µ —É—Ç–æ—á–Ω–∏ —É –º–µ—Å—Ç–Ω–æ–≥–æ –∞–≥—Ä–æ–Ω–æ–º–∞"
- –†–∞–∑–¥–µ–ª—è–π –≤ –≥–æ–ª–æ–≤–µ: —á—Ç–æ —Ç—ã –ó–ù–ê–ï–®–¨ —Ç–æ—á–Ω–æ, –∞ —á—Ç–æ —Ç–æ–ª—å–∫–æ –ü–†–ï–î–ü–û–õ–ê–ì–ê–ï–®–¨
- –ï—Å–ª–∏ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—à—å ‚Äî —Ç–∞–∫ –∏ —Å–∫–∞–∂–∏: "–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ...", "–í–æ–∑–º–æ–∂–Ω–æ...", "–ü–æ—Ö–æ–∂–µ –Ω–∞..."
- –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—è–π —Å–µ–±—è: –Ω–µ—Ç –ª–∏ –æ—à–∏–±–∫–∏ –≤ —Ç–≤–æ—ë–º –æ—Ç–≤–µ—Ç–µ?
- –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–æ–≤–æ—Ä–∏ –±—É–∫–≤–∞–ª—å–Ω–æ "—è –Ω–µ –∑–Ω–∞—é" ‚Äî –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –æ–±—ä—è—Å–Ω–∏ —á—Ç–æ –Ω–µ –Ω–∞—à—ë–ª —Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –ö–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö —Å–ª–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∏ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –∂–∏–∑–Ω–∏
- –ú–æ–∂–Ω–æ —à—É—Ç–∏—Ç—å –∏ –ø–æ–¥–±–∞–¥—Ä–∏–≤–∞—Ç—å
- –ì–æ–≤–æ—Ä–∏ "—Ç—ã", –∞ –Ω–µ "–≤—ã"
- –ù–µ –ø–∏—à–∏ –¥–ª–∏–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã ‚Äî –ª—É—á—à–µ –∫–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É

–¢–í–û–ò –ó–ù–ê–ù–ò–Ø:

–í–æ–¥–Ω—ã–π —Å—Ç—Ä–µ—Å—Å: –ö–æ–≥–¥–∞ –≤–æ–¥—ã –º–∞–ª–æ, —Ä–∞—Å—Ç–µ–Ω–∏–µ –≤—ã—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç "–≥–æ—Ä–º–æ–Ω –ø–∞–Ω–∏–∫–∏" (ABA) –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ—Ä—ã –Ω–∞ –ª–∏—Å—Ç—å—è—Ö, —á—Ç–æ–±—ã –Ω–µ –≤—ã—Å–æ—Ö–Ω—É—Ç—å. –ö–∞–∫ –±—É–¥—Ç–æ –∑–∞–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥—ã—Ö–∞–Ω–∏–µ.

–†–∞–∑–Ω—ã–µ —Ä–∞—Å—Ç–µ–Ω–∏—è:
- –ö–∞–∫—Ç—É—Å—ã –¥—ã—à–∞—Ç –Ω–æ—á—å—é, –¥–Ω—ë–º –∑–∞–∫—Ä—ã—Ç—ã ‚Äî —ç–∫–æ–Ω–æ–º—è—Ç –≤–æ–¥—É
- –¢—Ä–æ–ø–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–≤—ã–∫–ª–∏ –∫ –≤–ª–∞–≥–µ, –±–µ–∑ –Ω–µ—ë –±—ã—Å—Ç—Ä–æ –≥—Ä—É—Å—Ç–Ω–µ—é—Ç

–ï—Å–ª–∏ –ª–∏—Å—Ç—å—è –∂–µ–ª—Ç–µ—é—Ç ‚Äî –æ–±—ã—á–Ω–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø–∏—Ç–∞–Ω–∏—è –∏–ª–∏ –≤–æ–¥—ã.
–ï—Å–ª–∏ –ø—è—Ç–Ω–∞/–Ω–∞–ª—ë—Ç ‚Äî —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –≥—Ä–∏–±–æ–∫, –Ω—É–∂–Ω–æ –ª–µ—á–∏—Ç—å.

–ü–†–ò–ú–ï–†–´ –û–¢–í–ï–¢–û–í:

"–ü–æ—á–µ–º—É –ª–∏—Å—Ç—å—è –≤—è–Ω—É—Ç?"
‚Üí "–†–∞—Å—Ç–µ–Ω–∏—é –∂–∞—Ä–∫–æ –∏ –æ–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–æ—Ä—ã, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –≤–æ–¥—É. –ö–∞–∫ —Ç—ã –ø–æ—Ç–µ–µ—à—å –≤ –∂–∞—Ä—É ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞–æ–±–æ—Ä–æ—Ç, –æ–Ω–æ –≤–æ–¥—É —ç–∫–æ–Ω–æ–º–∏—Ç. –ü–æ–ª–µ–π —É—Ç—Ä–æ–º –∏–ª–∏ –≤–µ—á–µ—Ä–æ–º, –¥–æ–ª–∂–Ω–æ –ø–æ–º–æ—á—å!"

"–ß—Ç–æ —ç—Ç–æ –∑–∞ –ø—è—Ç–Ω–∞?"
‚Üí "–ü–æ—Ö–æ–∂–µ –Ω–∞ –≥—Ä–∏–±–æ–∫. –ü–æ–∫–∞–∂–∏ —Ñ–æ—Ç–æ –ø–æ–±–ª–∏–∂–µ ‚Äî —Å–∫–∞–∂—É —Ç–æ—á–Ω–µ–µ –∏ –ø–æ–¥—Å–∫–∞–∂—É —á–µ–º –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å."

–ü–†–ê–í–ò–õ–ê:
- –û—Ç–≤–µ—á–∞–π –Ω–∞ —è–∑—ã–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—É–∑–±–µ–∫—Å–∫–∏–π –∏–ª–∏ —Ä—É—Å—Å–∫–∏–π)
- –ù–∞ –≤–æ–ø—Ä–æ—Å—ã —Ç–∏–ø–∞ "–ø–æ—á–µ–º—É/–∫–∞–∫/—á—Ç–æ —Ç–∞–∫–æ–µ" ‚Äî –æ—Ç–≤–µ—á–∞–π —Å—Ä–∞–∑—É, –Ω–µ –ø—Ä–æ—Å–∏ —Ñ–æ—Ç–æ
- –§–æ—Ç–æ –ø—Ä–æ—Å–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–ø–∏—Å—ã–≤–∞—é—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –±–æ–ª—è—á–∫—É –∏ –±–µ–∑ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–µ –ø–æ–Ω—è—Ç—å"""


# –ü—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ
VISION_SYSTEM_PROMPT = """
–í–ê–ñ–ù–û: –≠—Ç–æ—Ç —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∑–∏–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–ª —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å –±–µ–∑ —Ñ–æ—Ç–æ ‚Äî –æ—Ç–≤–µ—á–∞–π –∫–∞–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —ç–∫—Å–ø–µ—Ä—Ç, –ù–ï –ü–†–û–°–ò –§–û–¢–û.

–¢—ã ‚Äî –∞–≥—Ä–æ–Ω–æ–º —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º. –¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –¢–û–õ–¨–ö–û —Ç–æ, —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –≤–∏–¥–Ω–æ –Ω–∞ —Ñ–æ—Ç–æ.
–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π —Å–∏–º–ø—Ç–æ–º—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ –≤–∏–¥–Ω–æ.

–ß–ï–°–¢–ù–û–°–¢–¨ –ò –¢–û–ß–ù–û–°–¢–¨:
- –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω –≤ –¥–∏–∞–≥–Ω–æ–∑–µ ‚Äî —Å–∫–∞–∂–∏ "–ø–æ—Ö–æ–∂–µ –Ω–∞..." –∏–ª–∏ "–≤–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ..."
- –ù–ï –≤—ã–¥—É–º—ã–≤–∞–π –±–æ–ª–µ–∑–Ω–∏. –ì–æ–≤–æ—Ä–∏ —Ç–æ–ª—å–∫–æ –æ —Ç–æ–º, —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –≤–∏–¥–∏—à—å
- –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ‚Äî —Å–∫–∞–∂–∏: "–ü–æ —ç—Ç–æ–º—É —Ñ–æ—Ç–æ —Å–ª–æ–∂–Ω–æ –¥–∞—Ç—å —Ç–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç, –ø–æ–ø—Ä–æ–±—É–π —Å—Ñ–æ—Ç–∫–∞—Ç—å –±–ª–∏–∂–µ"
- –†–∞–∑–¥–µ–ª—è–π: —á—Ç–æ —Ç—ã –í–ò–î–ò–®–¨ —Ç–æ—á–Ω–æ, –∞ —á—Ç–æ —Ç–æ–ª—å–∫–æ –ü–†–ï–î–ü–û–õ–ê–ì–ê–ï–®–¨
- –ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è ‚Äî –ª—É—á—à–µ —Å–∫–∞–∑–∞—Ç—å "–Ω–µ –º–æ–≥—É —Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å" —á–µ–º –¥–∞—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–æ–≤–µ—Ç
- –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–æ–≤–æ—Ä–∏ "—è –Ω–µ –∑–Ω–∞—é" ‚Äî –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –æ–±—ä—è—Å–Ω–∏ —á—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–π—Ç–∏ –¢–û–õ–¨–ö–û –û–î–ù–£ –æ—Å–Ω–æ–≤–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É —Ä–∞—Å—Ç–µ–Ω–∏—è.
–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ ‚Äî –≤—ã–±–µ—Ä–∏ —Å–∞–º—É—é –æ—á–µ–≤–∏–¥–Ω—É—é.

–°–∫–∞–∂–∏ —Å—Ç—Ä–æ–≥–æ –ø–æ –ø–æ—Ä—è–¥–∫—É –∏ –∫–æ—Ä–æ—Ç–∫–æ:

1. –†–∞—Å—Ç–µ–Ω–∏–µ ‚Äî –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º (–µ—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω, —Å–∫–∞–∂–∏ "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
2. –ü—Ä–æ–±–ª–µ–º–∞ ‚Äî –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º (–≥–Ω–∏–ª—å / –ø—è—Ç–Ω–∞ / –≤—Ä–µ–¥–∏—Ç–µ–ª–∏ / –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏—è / —Å—Ç—Ä–µ—Å—Å)
3. –î–∏–∞–≥–Ω–æ–∑ ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ –±–æ–ª–µ–∑–Ω–∏ –∏–ª–∏ –≤—Ä–µ–¥–∏—Ç–µ–ª—è (–µ—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω, —Å–∫–∞–∂–∏ "–ø–æ–¥–æ–∑—Ä–µ–Ω–∏–µ –Ω–∞ ...")

–û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø:
‚Äî –ù–µ –æ–ø–∏—Å—ã–≤–∞–π –≤—Å—ë —Ä–∞—Å—Ç–µ–Ω–∏–µ —Ü–µ–ª–∏–∫–æ–º  
‚Äî –ù–µ –ø–µ—Ä–µ—á–∏—Å–ª—è–π –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –±–æ–ª–µ–∑–Ω–∏  
‚Äî –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –Ω–∞—É—á–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è  
‚Äî –ù–µ –¥–∞–≤–∞–π —Å–æ–≤–µ—Ç–æ–≤, –µ—Å–ª–∏ –Ω–µ—Ç —è–≤–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –±–æ–ª–µ–∑–Ω–∏  

–ï–°–õ–ò:
‚Äî —Ä–∞—Å—Ç–µ–Ω–∏–µ –≤—ã–≥–ª—è–¥–∏—Ç –∑–¥–æ—Ä–æ–≤—ã–º ‚Üí —Å–∫–∞–∂–∏: "—Ä–∞—Å—Ç–µ–Ω–∏–µ –≤—ã–≥–ª—è–¥–∏—Ç –∑–¥–æ—Ä–æ–≤—ã–º"
‚Äî –Ω–∞ —Ñ–æ—Ç–æ –Ω–µ—Ç —Ä–∞—Å—Ç–µ–Ω–∏—è ‚Üí —Å–∫–∞–∂–∏: "–Ω–∞ —Ñ–æ—Ç–æ –Ω–µ—Ç —Ä–∞—Å—Ç–µ–Ω–∏—è"
‚Äî –∫–∞—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ –ø–ª–æ—Ö–æ–µ ‚Üí —Å–∫–∞–∂–∏: "–ø–æ —Ñ–æ—Ç–æ —Å–ª–æ–∂–Ω–æ —Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É"

–ü–û–°–õ–ï –î–ò–ê–ì–ù–û–ó–ê –≥–æ–≤–æ—Ä–∏ –∫–∞–∫ –∂–∏–≤–æ–π —Ñ–µ—Ä–º–µ—Ä-—Å–æ—Å–µ–¥:

1. –ù–∞–∑–æ–≤–∏ –ø—Ä–æ–±–ª–µ–º—É –ø—Ä—è–º–æ:
   "–≠—Ç–æ ..., –¥—Ä—É–≥ –º–æ–π"

2. –û–±—ä—è—Å–Ω–∏ –ü–†–û–°–¢–û, –ø–æ—á–µ–º—É —Ç—ã —Ç–∞–∫ —Ä–µ—à–∏–ª:
   ‚Äî —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–∞ —Ñ–æ—Ç–æ —Ç–µ–±—è –Ω–∞—Å—Ç–æ—Ä–æ–∂–∏–ª–æ

3. –î–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–æ–≤–µ—Ç—ã:
   ‚Äî —á—Ç–æ —É–±—Ä–∞—Ç—å / –æ–±—Ä–µ–∑–∞—Ç—å
   ‚Äî —á–µ–º –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å (–Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞)
   ‚Äî –ø—Ä–∏–º–µ—Ä–Ω–∞—è –¥–æ–∑–∏—Ä–æ–≤–∫–∞
   ‚Äî –∫–∞–∫ —á–∞—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä—è—Ç—å

4. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å 1 –Ω–∞—Ä–æ–¥–Ω—ã–π –º–µ—Ç–æ–¥ (–µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ)

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
‚Äî –ö–æ—Ä–æ—Ç–∫–æ
‚Äî –ë–µ–∑ –≤–æ–¥—ã
‚Äî –î—Ä—É–∂–µ–ª—é–±–Ω–æ
‚Äî –ü—Ä–∞–∫—Ç–∏—á–Ω–æ

–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —è–∑—ã–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
"""



class AIService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Groq AI API"""
    
    def __init__(self):
        self.api_key = settings.text_ai_api_key
        self.vision_api_key = settings.vision_ai_api_key
        self.text_model = settings.text_ai_model
        self.vision_model = settings.vision_ai_model
        self.api_url = "https://api.groq.com/openai/v1/chat/completions"

    async def get_response(
        self,
        message: str,
        conversation_id: str,
        image_url: Optional[str] = None,
        history: Optional[list] = None,
    ) -> dict:
        """–ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò"""
        
        try:
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∏—Å—Ç–æ—Ä–∏–µ–π
            messages = [{"role": "system", "content": TEXT_SYSTEM_PROMPT}]
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é (–¥–æ 100 —Å–æ–æ–±—â–µ–Ω–∏–π, –ø–æ—Ç–æ–º –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–±—ã–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ)
            if history:
                # –ï—Å–ª–∏ –±–æ–ª—å—à–µ 100 —Å–æ–æ–±—â–µ–Ω–∏–π - –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100
                history_to_use = history[-100:] if len(history) > 100 else history
                for msg in history_to_use:
                    messages.append({
                        "role": msg.get("role", "user"),
                        "content": msg.get("content", "")
                    })
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            messages.append({"role": "user", "content": message})
            
            async with httpx.AsyncClient(timeout=30.0) as client:
                response = await client.post(
                    self.api_url,
                    headers={
                        "Authorization": f"Bearer {self.api_key}",
                        "Content-Type": "application/json",
                    },
                    json={
                        "model": self.text_model,
                        "messages": messages,
                        "max_tokens": 1024,
                        "temperature": 0.7,
                    },
                )
                
                if response.status_code == 200:
                    data = response.json()
                    ai_text = data["choices"][0]["message"]["content"]
                    
                    return {
                        "text": ai_text,
                        "suggestions": self._generate_suggestions(message, ai_text),
                    }
                else:
                    print(f"Groq API error: {response.status_code} - {response.text}")
                    return self._get_fallback_response(message)
                    
        except Exception as e:
            print(f"AI Service error: {type(e).__name__}: {e}")
            return self._get_fallback_response(message)
    
    async def analyze_image(
        self,
        image_data: bytes,
        conversation_id: str,
        user_message: str = "",
    ) -> dict:
        """–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–∞—Å—Ç–µ–Ω–∏—è"""
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ base64
        image_base64 = base64.b64encode(image_data).decode("utf-8")
        
        try:
            async with httpx.AsyncClient(timeout=60.0) as client:
                response = await client.post(
                    self.api_url,
                    headers={
                        "Authorization": f"Bearer {self.vision_api_key}",
                        "Content-Type": "application/json",
                    },
                    json={
                        "model": self.vision_model,
                        "messages": [
                            {"role": "system", "content": VISION_SYSTEM_PROMPT},
                            {
                                "role": "user",
                                "content": [
                                    {
                                        "type": "image_url",
                                        "image_url": {
                                            "url": f"data:image/jpeg;base64,{image_base64}"
                                        },
                                    },
                                    {
                                        "type": "text",
                                        "text": user_message or "–ß—Ç–æ —Å —ç—Ç–∏–º —Ä–∞—Å—Ç–µ–Ω–∏–µ–º? –ü–æ–º–æ–≥–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É."
                                    },
                                ],
                            },
                        ],
                        "max_tokens": 1024,
                        "temperature": 0.5,
                    },
                )
                
                if response.status_code == 200:
                    data = response.json()
                    ai_text = data["choices"][0]["message"]["content"]
                    
                    # –ü–∞—Ä—Å–∏–º –¥–∏–∞–≥–Ω–æ–∑ –∏–∑ –æ—Ç–≤–µ—Ç–∞
                    diagnosis = self._parse_diagnosis(ai_text)
                    
                    return {
                        "text": ai_text,
                        "diagnosis": diagnosis,
                        "recommendations": self._extract_recommendations(ai_text),
                        "confidence": 0.75,
                    }
                else:
                    print(f"Groq Vision API error: {response.status_code} - {response.text}")
                    return self._get_fallback_image_response()
                    
        except Exception as e:
            print(f"Vision AI Service error: {e}")
            return self._get_fallback_image_response()
    
    def _generate_suggestions(self, message: str, response: str) -> list:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"""
        msg_lower = message.lower()
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫
        is_uzbek = any(word in msg_lower for word in ['qanday', 'nima', 'yordam', 'kasall', "o'g'it"])
        
        if is_uzbek:
            if 'kasall' in msg_lower or "dog'" in msg_lower:
                return ['Rasm yuklash', 'Davolash usullari', 'Profilaktika']
            if "o'g'it" in msg_lower:
                return ["Bug'doy uchun", 'Sabzavotlar uchun', 'Organik']
            return ['Rasm yuklash', 'Kasalliklar', "O'g'itlar"]
        else:
            if '–±–æ–ª–µ–∑–Ω' in msg_lower or '–ø—è—Ç–Ω' in msg_lower:
                return ['üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ', '–°–ø–æ—Å–æ–±—ã –ª–µ—á–µ–Ω–∏—è', '–ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞']
            if '—É–¥–æ–±—Ä–µ–Ω' in msg_lower:
                return ['–î–ª—è –ø—à–µ–Ω–∏—Ü—ã', '–î–ª—è –æ–≤–æ—â–µ–π', '–û—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–µ']
            if '–≤—Ä–µ–¥–∏—Ç–µ–ª' in msg_lower:
                return ['üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ', '–ù–∞—Ä–æ–¥–Ω—ã–µ –º–µ—Ç–æ–¥—ã', '–•–∏–º–∏—è']
            return ['üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ', '–ë–æ–ª–µ–∑–Ω–∏', '–£–¥–æ–±—Ä–µ–Ω–∏—è']
    
    def _parse_diagnosis(self, text: str) -> list:
        """–ü–∞—Ä—Å–∏–Ω–≥ –¥–∏–∞–≥–Ω–æ–∑–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –æ—Ç–≤–µ—Ç–∞"""
        # –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ - –∏—â–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –±–æ–ª–µ–∑–Ω–µ–π
        diseases = {
            '—Å–µ—Ä–∞—è –≥–Ω–∏–ª—å': ('–°–µ—Ä–∞—è –≥–Ω–∏–ª—å', '–ì—Ä–∏–±–∫–æ–≤–æ–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–µ'),
            '–º—É—á–Ω–∏—Å—Ç–∞—è —Ä–æ—Å–∞': ('–ú—É—á–Ω–∏—Å—Ç–∞—è —Ä–æ—Å–∞', '–ë–µ–ª—ã–π –Ω–∞–ª—ë—Ç –Ω–∞ –ª–∏—Å—Ç—å—è—Ö'),
            '—Ñ–∏—Ç–æ—Ñ—Ç–æ—Ä–æ–∑': ('–§–∏—Ç–æ—Ñ—Ç–æ—Ä–æ–∑', '–ë—É—Ä—ã–µ –ø—è—Ç–Ω–∞ –Ω–∞ –ª–∏—Å—Ç—å—è—Ö'),
            '—Ö–ª–æ—Ä–æ–∑': ('–•–ª–æ—Ä–æ–∑', '–ü–æ–∂–µ–ª—Ç–µ–Ω–∏–µ –ª–∏—Å—Ç—å–µ–≤'),
            '—Ç–ª—è': ('–¢–ª—è', '–ú–µ–ª–∫–∏–µ –Ω–∞—Å–µ–∫–æ–º—ã–µ –Ω–∞ –ª–∏—Å—Ç—å—è—Ö'),
            '–ø–∞—É—Ç–∏–Ω–Ω—ã–π –∫–ª–µ—â': ('–ü–∞—É—Ç–∏–Ω–Ω—ã–π –∫–ª–µ—â', '–ú–µ–ª–∫–∏–µ —Ç–æ—á–∫–∏ –∏ –ø–∞—É—Ç–∏–Ω–∞'),
            'kulrang chirish': ('Kulrang chirish', "Zamburug' kasalligi"),
            'un shudring': ('Un shudring', 'Barglarda oq qoplama'),
            'fitoftoroz': ('Fitoftoroz', "Barglarda jigarrang dog'lar"),
        }
        
        text_lower = text.lower()
        found = []
        
        for key, (name, desc) in diseases.items():
            if key in text_lower:
                found.append(Diagnosis(
                    name=name,
                    probability=75,
                    description=desc,
                    recommendations=[],
                ))
        
        return found if found else None
    
    def _extract_recommendations(self, text: str) -> list:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
        recommendations = []
        
        # –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
        keywords = ['–æ–±—Ä–∞–±–æ—Ç', '–æ–ø—Ä—ã—Å–∫–∞', '—É–¥–∞–ª–∏', '–ø–æ–ª–∏–≤', 'ishlov', 'purkash', "olib tashla"]
        
        for line in text.split('\n'):
            line_lower = line.lower()
            if any(kw in line_lower for kw in keywords):
                clean_line = line.strip('- ‚Ä¢').strip()
                if clean_line and len(clean_line) > 10:
                    recommendations.append(clean_line)
        
        return recommendations[:5] if recommendations else [
            "–°–ª–µ–¥—É–π—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º –≤—ã—à–µ",
            "–ü—Ä–∏ —É—Ö—É–¥—à–µ–Ω–∏–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É"
        ]
    
    def _get_fallback_response(self, message: str) -> dict:
        """–ó–∞–ø–∞—Å–Ω–æ–π –æ—Ç–≤–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ API"""
        msg_lower = message.lower()
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫
        is_uzbek = any(word in msg_lower for word in ['qanday', 'nima', 'yordam', 'salom', "o'simlik"])
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π –ª–∏ –≤–æ–ø—Ä–æ—Å
        theory_keywords = ['–º–æ–ª–µ–∫—É–ª—è—Ä', '–ø–æ—á–µ–º—É', '–∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç', '–º–µ—Ö–∞–Ω–∏–∑–º', '–ø—Ä–æ—Ü–µ—Å—Å', 
                          '–±–∏–æ—Ö–∏–º', '—Å–∏–≥–Ω–∞–ª', '–∫–ª–µ—Ç–∫', '–≥–æ—Ä–º–æ–Ω', '—Ñ–æ—Ç–æ—Å–∏–Ω—Ç–µ–∑', '—É—Å—Ç—å–∏—Ü',
                          'qanday ishlaydi', 'mexanizm', 'nima uchun']
        is_theory = any(kw in msg_lower for kw in theory_keywords)
        
        if is_theory:
            if is_uzbek:
                return {
                    "text": "Zo'r savol!\n\nO'simlik suv yetishmasligini hujayralarida bosim tushishi orqali sezadi. Keyin ABA gormoni chiqadi ‚Äî bu \"stress signali\", u og'izchalarni yopadi.\n\nKaktus va aloye kechasi nafas oladi, kunduzi yopiq ‚Äî shuning uchun cho'lda yashaydi. Tropik o'simliklar bunday qila olmaydi, ularga doim nam kerak.\n\nO'simliklar ham o'z usulida omon qolishga harakat qiladi ‚Äî hammasi shu!",
                    "suggestions": ["Batafsil ma'lumot", "Boshqa savol", "Kasalliklar haqida"],
                }
            else:
                return {
                    "text": "–ö–ª–∞—Å—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å!\n\n–ö–æ–≥–¥–∞ –≤–æ–¥—ã –º–∞–ª–æ ‚Äî –≤ –∫–ª–µ—Ç–∫–∞—Ö –ø–∞–¥–∞–µ—Ç –¥–∞–≤–ª–µ–Ω–∏–µ, –∏ —Ä–∞—Å—Ç–µ–Ω–∏–µ —ç—Ç–æ —á—É–≤—Å—Ç–≤—É–µ—Ç. –í—ã—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≥–æ—Ä–º–æ–Ω —Å—Ç—Ä–µ—Å—Å–∞ ABA, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —É—Å—Ç—å–∏—Ü–∞, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –≤–æ–¥—É.\n\n–ö–∞–∫—Ç—É—Å—ã –∏ –∞–ª–æ—ç –¥—ã—à–∞—Ç –Ω–æ—á—å—é, –∞ –¥–Ω—ë–º —É—Å—Ç—å–∏—Ü–∞ –∑–∞–∫—Ä—ã—Ç—ã ‚Äî —Ö–∏—Ç—Ä–æ, –¥–∞? –ü–æ—ç—Ç–æ–º—É –≤ –ø—É—Å—Ç—ã–Ω–µ –≤—ã–∂–∏–≤–∞—é—Ç. –¢—Ä–æ–ø–∏—á–µ—Å–∫–∏–µ —Ç–∞–∫ –Ω–µ —É–º–µ—é—Ç ‚Äî –∏–º –Ω—É–∂–Ω–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å.\n\n–†–∞—Å—Ç–µ–Ω–∏—è —Ç–æ–∂–µ –∏—â—É—Ç —Å–≤–æ–π —Å–ø–æ—Å–æ–± –≤—ã–∂–∏–≤–∞—Ç—å ‚Äî –≤–æ—Ç –∏ –≤—Å—ë!",
                    "suggestions": ['–ü–æ–¥—Ä–æ–±–Ω–µ–µ –ø—Ä–æ —ç—Ç–æ', '–î—Ä—É–≥–æ–π –≤–æ–ø—Ä–æ—Å', '–ë–æ–ª–µ–∑–Ω–∏ —Ä–∞—Å—Ç–µ–Ω–∏–π'],
                }
        
        if is_uzbek:
            return {
                "text": "Savolingizni tushundim! Aniqroq javob berish uchun menga ko'proq ma'lumot kerak. O'simlik rasmini yuklasangiz, muammoni aniqroq ko'ra olaman.",
                "suggestions": ['Rasm yuklash', 'Kasalliklar', "O'g'itlar"],
            }
        else:
            return {
                "text": "–ü–æ–Ω—è–ª —Ç–≤–æ–π –≤–æ–ø—Ä–æ—Å! –ß—Ç–æ–±—ã –¥–∞—Ç—å —Ç–æ—á–Ω—ã–π —Å–æ–≤–µ—Ç, –º–Ω–µ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –ó–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ —Ä–∞—Å—Ç–µ–Ω–∏—è ‚Äî —Ç–∞–∫ —è –ª—É—á—à–µ —É–≤–∏–∂—É –ø—Ä–æ–±–ª–µ–º—É üì∑",
                "suggestions": ['üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ', '–ë–æ–ª–µ–∑–Ω–∏', '–£–¥–æ–±—Ä–µ–Ω–∏—è'],
            }
    
    def _get_fallback_image_response(self) -> dict:
        """–ó–∞–ø–∞—Å–Ω–æ–π –æ—Ç–≤–µ—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"""
        return {
            "text": "–•–º, –Ω–µ –º–æ–≥—É —á—ë—Ç–∫–æ —Ä–∞–∑–≥–ª—è–¥–µ—Ç—å –ø—Ä–æ–±–ª–µ–º—É –Ω–∞ —Ñ–æ—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π —Å—Ñ–æ—Ç–∫–∞—Ç—å –ø–æ–±–ª–∏–∂–µ –ø—Ä–∏ —Ö–æ—Ä–æ—à–µ–º –æ—Å–≤–µ—â–µ–Ω–∏–∏ ‚Äî –ª–∏—Å—Ç—å—è –∏–ª–∏ –ø–æ—Ä–∞–∂—ë–Ω–Ω–æ–µ –º–µ—Å—Ç–æ. –¢–∞–∫ —Å–º–æ–≥—É —Ç–æ—á–Ω–µ–µ —Å–∫–∞–∑–∞—Ç—å —á—Ç–æ –¥–µ–ª–∞—Ç—å! üì∏",
            "diagnosis": None,
            "recommendations": [
                "–°–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ –ø—Ä–∏ –¥–Ω–µ–≤–Ω–æ–º —Å–≤–µ—Ç–µ",
                "–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –ø–æ—Ä–∞–∂—ë–Ω–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ –∫—Ä—É–ø–Ω—ã–º –ø–ª–∞–Ω–æ–º",
            ],
            "confidence": 0.3,
        }
